<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Pausarr</title>
        <style>
            :root {
                --bg-primary: #0f0f0f;
                --bg-secondary: #1a1a1a;
                --bg-tertiary: #252525;
                --accent: #00a4dc;
                --accent-hover: #0088b9;
                --success: #4caf50;
                --warning: #ff9800;
                --danger: #f44336;
                --text-primary: #ffffff;
                --text-secondary: #b3b3b3;
                --border: #333;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                min-height: 100vh;
                line-height: 1.5;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            header {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border);
                padding: 15px 0;
                margin-bottom: 30px;
            }

            header .container {
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .logo {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .logo svg {
                width: 36px;
                height: 36px;
                fill: var(--accent);
            }

            .logo h1 {
                font-size: 1.5rem;
                font-weight: 600;
            }

            .global-toggle {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .toggle-switch {
                position: relative;
                width: 50px;
                height: 26px;
            }

            .toggle-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .toggle-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--bg-tertiary);
                border-radius: 26px;
                transition: 0.3s;
            }

            .toggle-slider:before {
                position: absolute;
                content: "";
                height: 20px;
                width: 20px;
                left: 3px;
                bottom: 3px;
                background: white;
                border-radius: 50%;
                transition: 0.3s;
            }

            .toggle-switch input:checked + .toggle-slider {
                background: var(--accent);
            }

            .toggle-switch input:checked + .toggle-slider:before {
                transform: translateX(24px);
            }

            .dashboard {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .card {
                background: var(--bg-secondary);
                border-radius: 12px;
                padding: 20px;
                border: 1px solid var(--border);
            }

            .card h2 {
                font-size: 1rem;
                color: var(--text-secondary);
                margin-bottom: 15px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .status-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .status-item {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }

            .status-label {
                font-size: 0.75rem;
                color: var(--text-secondary);
                text-transform: uppercase;
            }

            .status-value {
                font-size: 1.1rem;
                font-weight: 500;
            }

            .status-indicator {
                display: inline-flex;
                align-items: center;
                gap: 6px;
            }

            .status-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: var(--text-secondary);
            }

            .status-dot.active {
                background: var(--success);
                box-shadow: 0 0 8px var(--success);
            }

            .status-dot.paused {
                background: var(--warning);
                box-shadow: 0 0 8px var(--warning);
            }

            .status-dot.error {
                background: var(--danger);
                box-shadow: 0 0 8px var(--danger);
            }

            .btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-primary {
                background: var(--accent);
                color: white;
            }

            .btn-primary:hover {
                background: var(--accent-hover);
            }

            .btn-secondary {
                background: var(--bg-tertiary);
                color: var(--text-primary);
            }

            .btn-secondary:hover {
                background: #333;
            }

            .btn-success {
                background: var(--success);
                color: white;
            }

            .btn-warning {
                background: var(--warning);
                color: black;
            }

            .btn-danger {
                background: var(--danger);
                color: white;
            }

            .btn-sm {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .btn:disabled {
                opacity: 0.4;
                cursor: not-allowed;
                pointer-events: none;
                filter: grayscale(50%);
            }

            .btn-group {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .section {
                margin-bottom: 30px;
            }

            .section-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 15px;
            }

            .section-title {
                font-size: 1.25rem;
                font-weight: 600;
            }

            .container-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .container-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 10px;
                padding: 15px 20px;
                transition: border-color 0.2s;
            }

            .container-item:hover {
                border-color: var(--accent);
            }

            .container-item.managed {
                border-left: 3px solid var(--accent);
            }

            .container-info {
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .container-name {
                font-weight: 500;
                font-size: 1rem;
            }

            .container-image {
                font-size: 0.8rem;
                color: var(--text-secondary);
            }

            .container-status {
                font-size: 0.75rem;
                padding: 4px 10px;
                border-radius: 20px;
                text-transform: uppercase;
                font-weight: 500;
            }

            .container-status.running {
                background: rgba(76, 175, 80, 0.2);
                color: var(--success);
            }

            .container-status.paused {
                background: rgba(255, 152, 0, 0.2);
                color: var(--warning);
            }

            .container-status.exited {
                background: rgba(244, 67, 54, 0.2);
                color: var(--danger);
            }

            .container-actions {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .sessions-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .session-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 12px;
                background: var(--bg-tertiary);
                border-radius: 8px;
            }

            .session-info {
                display: flex;
                flex-direction: column;
                gap: 3px;
            }

            .session-user {
                font-weight: 500;
            }

            .session-device {
                font-size: 0.8rem;
                color: var(--text-secondary);
            }

            .session-playing {
                font-size: 0.85rem;
                color: var(--accent);
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-size: 0.85rem;
                color: var(--text-secondary);
            }

            .form-control {
                width: 100%;
                padding: 10px 15px;
                border: 1px solid var(--border);
                border-radius: 8px;
                background: var(--bg-tertiary);
                color: var(--text-primary);
                font-size: 0.95rem;
            }

            .form-control:focus {
                outline: none;
                border-color: var(--accent);
            }

            .form-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .history-list {
                max-height: 300px;
                overflow-y: auto;
            }

            .history-item {
                padding: 10px;
                border-bottom: 1px solid var(--border);
                font-size: 0.85rem;
            }

            .history-item:last-child {
                border-bottom: none;
            }

            .history-time {
                color: var(--text-secondary);
                font-size: 0.75rem;
            }

            .history-action {
                font-weight: 500;
            }

            .empty-state {
                text-align: center;
                padding: 40px;
                color: var(--text-secondary);
            }

            .toast-container {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1000;
            }

            .toast {
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 15px 20px;
                margin-top: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease;
            }

            .toast.success {
                border-left: 3px solid var(--success);
            }

            .toast.error {
                border-left: 3px solid var(--danger);
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 1000;
                align-items: center;
                justify-content: center;
            }

            .modal.active {
                display: flex;
            }

            .modal-content {
                background: var(--bg-secondary);
                border-radius: 12px;
                padding: 25px;
                width: 90%;
                max-width: 500px;
                border: 1px solid var(--border);
            }

            .modal-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 20px;
            }

            .modal-title {
                font-size: 1.25rem;
                font-weight: 600;
            }

            .modal-close {
                background: none;
                border: none;
                color: var(--text-secondary);
                font-size: 1.5rem;
                cursor: pointer;
            }

            .modal-footer {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 20px;
            }

            .tabs {
                display: flex;
                border-bottom: 1px solid var(--border);
                margin-bottom: 20px;
            }

            .tab {
                padding: 10px 20px;
                cursor: pointer;
                color: var(--text-secondary);
                border-bottom: 2px solid transparent;
                transition: all 0.2s;
            }

            .tab:hover {
                color: var(--text-primary);
            }

            .tab.active {
                color: var(--accent);
                border-bottom-color: var(--accent);
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            @media (max-width: 768px) {
                .container {
                    padding: 15px;
                }

                .dashboard {
                    grid-template-columns: 1fr;
                }

                .container-item {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 15px;
                }

                .container-actions {
                    width: 100%;
                    justify-content: flex-end;
                }
            }
        </style>
    </head>
    <body>
        <header>
            <div class="container">
                <div class="logo">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14H8V8h2v8zm6 0h-2V8h2v8z"
                        />
                    </svg>
                    <h1>Pausarr</h1>
                </div>
                <div class="global-toggle">
                    <span id="global-status-text">Enabled</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="global-toggle" checked />
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </header>

        <main class="container">
            <div class="dashboard">
                <div class="card">
                    <h2>Monitor Status</h2>
                    <div class="status-grid">
                        <div class="status-item">
                            <span class="status-label">Status</span>
                            <span class="status-value">
                                <span class="status-indicator">
                                    <span
                                        class="status-dot"
                                        id="monitor-dot"
                                    ></span>
                                    <span id="monitor-status">Stopped</span>
                                </span>
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Last Check</span>
                            <span class="status-value" id="last-check"
                                >Never</span
                            >
                        </div>
                        <div class="status-item">
                            <span class="status-label">Playback</span>
                            <span class="status-value">
                                <span class="status-indicator">
                                    <span
                                        class="status-dot"
                                        id="playing-dot"
                                    ></span>
                                    <span id="playing-status">Unknown</span>
                                </span>
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Containers</span>
                            <span class="status-value">
                                <span class="status-indicator">
                                    <span
                                        class="status-dot"
                                        id="containers-dot"
                                    ></span>
                                    <span id="containers-status">Unknown</span>
                                </span>
                            </span>
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top: 20px">
                        <button
                            class="btn btn-primary btn-sm"
                            id="btn-start-monitor"
                        >
                            Start Monitor
                        </button>
                        <button
                            class="btn btn-secondary btn-sm"
                            id="btn-stop-monitor"
                        >
                            Stop Monitor
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2>Quick Actions</h2>
                    <div class="btn-group" style="margin-bottom: 15px">
                        <button class="btn btn-warning" id="btn-pause-all">
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                            >
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                            </svg>
                            Pause All
                        </button>
                        <button class="btn btn-success" id="btn-unpause-all">
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                            >
                                <path d="M8 5v14l11-7z" />
                            </svg>
                            Unpause All
                        </button>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary)">
                        Manually pause or unpause all managed containers
                        regardless of Jellyfin sessions.
                    </p>
                </div>

                <div class="card">
                    <h2>Jellyfin Connection</h2>
                    <div
                        id="jellyfin-status"
                        class="status-item"
                        style="margin-bottom: 15px"
                    >
                        <span class="status-indicator">
                            <span class="status-dot" id="jellyfin-dot"></span>
                            <span id="jellyfin-connection">Not configured</span>
                        </span>
                    </div>
                    <button class="btn btn-secondary btn-sm" id="btn-settings">
                        <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                        >
                            <path
                                d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"
                            />
                        </svg>
                        Settings
                    </button>
                </div>
            </div>

            <div class="section">
                <div class="tabs">
                    <div class="tab active" data-tab="containers">
                        Containers
                    </div>
                    <div class="tab" data-tab="sessions">Jellyfin Sessions</div>
                    <div class="tab" data-tab="history">Activity Log</div>
                </div>

                <div class="tab-content active" id="tab-containers">
                    <div class="section-header">
                        <h2 class="section-title">Docker Containers</h2>
                        <button
                            class="btn btn-secondary btn-sm"
                            id="btn-refresh-containers"
                        >
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                            >
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
                                />
                            </svg>
                            Refresh
                        </button>
                    </div>
                    <div class="container-list" id="container-list">
                        <div class="empty-state">Loading containers...</div>
                    </div>
                </div>

                <div class="tab-content" id="tab-sessions">
                    <div class="section-header">
                        <h2 class="section-title">Active Sessions</h2>
                        <button
                            class="btn btn-secondary btn-sm"
                            id="btn-refresh-sessions"
                        >
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                            >
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
                                />
                            </svg>
                            Refresh
                        </button>
                    </div>
                    <div class="sessions-list" id="sessions-list">
                        <div class="empty-state">Loading sessions...</div>
                    </div>
                </div>

                <div class="tab-content" id="tab-history">
                    <h2 class="section-title">Activity Log</h2>
                    <div class="card" style="margin-top: 15px">
                        <div class="history-list" id="history-list">
                            <div class="empty-state">No activity yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Settings Modal -->
        <div class="modal" id="settings-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Settings</h3>
                    <button class="modal-close" id="btn-close-settings">
                        &times;
                    </button>
                </div>
                <form id="settings-form">
                    <div class="form-group">
                        <label for="jellyfin-url">Jellyfin URL</label>
                        <input
                            type="url"
                            class="form-control"
                            id="jellyfin-url"
                            placeholder="http://localhost:8096"
                        />
                    </div>
                    <div class="form-group">
                        <label for="jellyfin-api-key">API Key</label>
                        <input
                            type="password"
                            class="form-control"
                            id="jellyfin-api-key"
                            placeholder="Enter API key"
                        />
                    </div>
                    <div class="form-group">
                        <label for="check-interval"
                            >Check Interval (seconds)</label
                        >
                        <input
                            type="number"
                            class="form-control"
                            id="check-interval"
                            min="5"
                            max="300"
                            value="30"
                        />
                    </div>
                    <div class="form-group">
                        <button
                            type="button"
                            class="btn btn-secondary btn-sm"
                            id="btn-test-connection"
                        >
                            Test Connection
                        </button>
                        <span
                            id="test-result"
                            style="margin-left: 10px; font-size: 0.85rem"
                        ></span>
                    </div>
                    <div class="modal-footer">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            id="btn-cancel-settings"
                        >
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Save Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="toast-container" id="toast-container"></div>

        <script>
            // Utility functions
            function showToast(message, type = "success") {
                const container = document.getElementById("toast-container");
                const toast = document.createElement("div");
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            }

            async function api(endpoint, method = "GET", data = null) {
                const options = {
                    method,
                    headers: { "Content-Type": "application/json" },
                };
                if (data) options.body = JSON.stringify(data);
                const response = await fetch(`/api${endpoint}`, options);
                return response.json();
            }

            function formatTime(isoString) {
                if (!isoString) return "Never";
                const date = new Date(isoString);
                return date.toLocaleTimeString();
            }

            // Tab switching
            document.querySelectorAll(".tab").forEach((tab) => {
                tab.addEventListener("click", () => {
                    document
                        .querySelectorAll(".tab")
                        .forEach((t) => t.classList.remove("active"));
                    document
                        .querySelectorAll(".tab-content")
                        .forEach((c) => c.classList.remove("active"));
                    tab.classList.add("active");
                    document
                        .getElementById(`tab-${tab.dataset.tab}`)
                        .classList.add("active");
                });
            });

            // Modal handling
            const settingsModal = document.getElementById("settings-modal");
            document
                .getElementById("btn-settings")
                .addEventListener("click", async () => {
                    const config = await api("/config");
                    document.getElementById("jellyfin-url").value =
                        config.jellyfin_url || "";
                    document.getElementById("jellyfin-api-key").value =
                        config.jellyfin_api_key || "";
                    document.getElementById("check-interval").value =
                        config.check_interval || 30;
                    settingsModal.classList.add("active");
                });
            document
                .getElementById("btn-close-settings")
                .addEventListener("click", () =>
                    settingsModal.classList.remove("active"),
                );
            document
                .getElementById("btn-cancel-settings")
                .addEventListener("click", () =>
                    settingsModal.classList.remove("active"),
                );
            settingsModal.addEventListener("click", (e) => {
                if (e.target === settingsModal)
                    settingsModal.classList.remove("active");
            });

            // Settings form
            document
                .getElementById("settings-form")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const data = {
                        jellyfin_url:
                            document.getElementById("jellyfin-url").value,
                        jellyfin_api_key:
                            document.getElementById("jellyfin-api-key").value,
                        check_interval: parseInt(
                            document.getElementById("check-interval").value,
                        ),
                    };
                    await api("/config", "POST", data);
                    showToast("Settings saved");
                    settingsModal.classList.remove("active");
                    loadStatus();
                });

            // Test connection
            document
                .getElementById("btn-test-connection")
                .addEventListener("click", async () => {
                    const result = document.getElementById("test-result");
                    result.textContent = "Testing...";
                    result.style.color = "var(--text-secondary)";

                    const data = {
                        url: document.getElementById("jellyfin-url").value,
                        api_key:
                            document.getElementById("jellyfin-api-key").value,
                    };
                    const response = await api("/jellyfin/test", "POST", data);

                    result.textContent = response.message;
                    result.style.color = response.success
                        ? "var(--success)"
                        : "var(--danger)";
                });

            // Global toggle
            document
                .getElementById("global-toggle")
                .addEventListener("change", async (e) => {
                    const enabled = e.target.checked;
                    await api(enabled ? "/enable" : "/disable", "POST");
                    document.getElementById("global-status-text").textContent =
                        enabled ? "Enabled" : "Disabled";
                    showToast(enabled ? "Pausarr enabled" : "Pausarr disabled");
                });

            // Monitor controls
            document
                .getElementById("btn-start-monitor")
                .addEventListener("click", async () => {
                    await api("/monitor/start", "POST");
                    showToast("Monitor started");
                    loadStatus();
                });

            document
                .getElementById("btn-stop-monitor")
                .addEventListener("click", async () => {
                    await api("/monitor/stop", "POST");
                    showToast("Monitor stopped");
                    loadStatus();
                });

            // Quick actions
            document
                .getElementById("btn-pause-all")
                .addEventListener("click", async () => {
                    const result = await api("/monitor/pause-all", "POST");
                    showToast(
                        result.success
                            ? "All containers paused"
                            : "Some containers failed to pause",
                        result.success ? "success" : "error",
                    );
                    loadContainers();
                    loadStatus();
                });

            document
                .getElementById("btn-unpause-all")
                .addEventListener("click", async () => {
                    const result = await api("/monitor/unpause-all", "POST");
                    showToast(
                        result.success
                            ? "All containers unpaused"
                            : "Some containers failed to unpause",
                        result.success ? "success" : "error",
                    );
                    loadContainers();
                    loadStatus();
                });

            // Refresh buttons
            document
                .getElementById("btn-refresh-containers")
                .addEventListener("click", loadContainers);
            document
                .getElementById("btn-refresh-sessions")
                .addEventListener("click", loadSessions);

            // Load status
            async function loadStatus() {
                const status = await api("/status");

                // Global toggle
                document.getElementById("global-toggle").checked =
                    status.config_enabled;
                document.getElementById("global-status-text").textContent =
                    status.config_enabled ? "Enabled" : "Disabled";

                // Monitor status and button states
                const monitorDot = document.getElementById("monitor-dot");
                const monitorStatus = document.getElementById("monitor-status");
                const btnStart = document.getElementById("btn-start-monitor");
                const btnStop = document.getElementById("btn-stop-monitor");

                if (status.running) {
                    monitorDot.className = "status-dot active";
                    monitorStatus.textContent = "Running";
                    btnStart.disabled = true;
                    btnStop.disabled = false;
                } else {
                    monitorDot.className = "status-dot";
                    monitorStatus.textContent = "Stopped";
                    btnStart.disabled = false;
                    btnStop.disabled = true;
                }

                // Last check
                document.getElementById("last-check").textContent = formatTime(
                    status.last_check,
                );

                // Playback status
                const playingDot = document.getElementById("playing-dot");
                const playingStatus = document.getElementById("playing-status");
                if (status.playing_active) {
                    playingDot.className = "status-dot active";
                    playingStatus.textContent = "Playing";
                } else {
                    playingDot.className = "status-dot";
                    playingStatus.textContent = "Idle";
                }

                // Containers status - check actual container states
                const containersDot = document.getElementById("containers-dot");
                const containersStatus =
                    document.getElementById("containers-status");

                // Get actual container states from the containers API
                const containers = await api("/containers");
                const managedContainers = containers.filter(
                    (c) => c.managed && c.enabled,
                );
                const pausedCount = managedContainers.filter(
                    (c) => c.status === "paused",
                ).length;
                const totalManaged = managedContainers.length;

                if (totalManaged === 0) {
                    containersDot.className = "status-dot";
                    containersStatus.textContent = "None managed";
                } else if (pausedCount === totalManaged) {
                    containersDot.className = "status-dot paused";
                    containersStatus.textContent = `Paused (${pausedCount})`;
                } else if (pausedCount > 0) {
                    containersDot.className = "status-dot paused";
                    containersStatus.textContent = `Mixed (${pausedCount}/${totalManaged})`;
                } else {
                    containersDot.className = "status-dot active";
                    containersStatus.textContent = `Running (${totalManaged})`;
                }

                // Error status
                if (status.error) {
                    monitorDot.className = "status-dot error";
                }

                // History
                const historyList = document.getElementById("history-list");
                if (status.history && status.history.length > 0) {
                    historyList.innerHTML = status.history
                        .reverse()
                        .map(
                            (h) => `
                    <div class="history-item">
                        <span class="history-time">${formatTime(h.timestamp)}</span>
                        <span class="history-action">${h.action}</span>
                        ${h.details ? `<span> - ${h.details}</span>` : ""}
                    </div>
                `,
                        )
                        .join("");
                } else {
                    historyList.innerHTML =
                        '<div class="empty-state">No activity yet</div>';
                }

                // Jellyfin connection
                const jellyfinDot = document.getElementById("jellyfin-dot");
                const jellyfinConnection = document.getElementById(
                    "jellyfin-connection",
                );
                const config = await api("/config");
                if (config.jellyfin_api_key_set) {
                    const test = await api("/jellyfin/test", "POST", {});
                    if (test.success) {
                        jellyfinDot.className = "status-dot active";
                        jellyfinConnection.textContent = test.message;
                    } else {
                        jellyfinDot.className = "status-dot error";
                        jellyfinConnection.textContent = test.message;
                    }
                } else {
                    jellyfinDot.className = "status-dot";
                    jellyfinConnection.textContent = "Not configured";
                }
            }

            // Load containers
            async function loadContainers() {
                const containers = await api("/containers");
                const list = document.getElementById("container-list");

                if (containers.length === 0) {
                    list.innerHTML =
                        '<div class="empty-state">No containers found</div>';
                    return;
                }

                list.innerHTML = containers
                    .map(
                        (c) => `
                <div class="container-item ${c.managed ? "managed" : ""}">
                    <div class="container-info">
                        <span class="container-status ${c.status}">${c.status}</span>
                        <div>
                            <div class="container-name">${c.name}</div>
                            <div class="container-image">${c.image}</div>
                        </div>
                    </div>
                    <div class="container-actions">
                        ${
                            c.managed
                                ? `
                            <label class="toggle-switch" title="Enable/disable for auto-pause">
                                <input type="checkbox" ${c.enabled ? "checked" : ""} onchange="toggleContainer('${c.name}')">
                                <span class="toggle-slider"></span>
                            </label>
                            <button class="btn btn-secondary btn-sm" onclick="unmanageContainer('${c.name}')">Remove</button>
                        `
                                : `
                            <button class="btn btn-primary btn-sm" onclick="manageContainer('${c.name}')">Add to Pausarr</button>
                        `
                        }
                        ${
                            c.status === "running"
                                ? `
                            <button class="btn btn-warning btn-sm" onclick="pauseContainer('${c.name}')">Pause</button>
                        `
                                : c.status === "paused"
                                  ? `
                            <button class="btn btn-success btn-sm" onclick="unpauseContainer('${c.name}')">Unpause</button>
                        `
                                  : ""
                        }
                    </div>
                </div>
            `,
                    )
                    .join("");
            }

            // Load sessions
            let previousSessionsJson = "";

            async function loadSessions() {
                const sessions = await api("/jellyfin/sessions");
                const list = document.getElementById("sessions-list");

                // Check if sessions changed to update playback status
                const currentJson = JSON.stringify(sessions);
                if (currentJson !== previousSessionsJson) {
                    previousSessionsJson = currentJson;

                    // Update playback indicator based on actual sessions
                    const playingDot = document.getElementById("playing-dot");
                    const playingStatus =
                        document.getElementById("playing-status");
                    const playingCount = sessions.filter(
                        (s) => s.now_playing,
                    ).length;

                    if (playingCount > 0) {
                        playingDot.className = "status-dot active";
                        playingStatus.textContent = `Playing (${playingCount})`;
                    } else {
                        playingDot.className = "status-dot";
                        playingStatus.textContent = "Idle";
                    }
                }

                if (sessions.length === 0) {
                    list.innerHTML =
                        '<div class="empty-state">No active sessions</div>';
                    return;
                }

                list.innerHTML = sessions
                    .map(
                        (s) => `
                <div class="session-item">
                    <div class="session-info">
                        <span class="session-user">${s.user_name || "Unknown"}</span>
                        <span class="session-device">${s.client} on ${s.device_name}</span>
                        ${s.now_playing ? `<span class="session-playing">â–¶ ${s.now_playing}</span>` : '<span class="session-device">Not playing</span>'}
                    </div>
                    <span class="status-indicator">
                        <span class="status-dot ${s.now_playing ? "active" : ""}"></span>
                        ${s.now_playing ? "Playing" : "Idle"}
                    </span>
                </div>
            `,
                    )
                    .join("");
            }

            // Container actions
            async function manageContainer(name) {
                await api(`/containers/${name}/manage`, "POST", {
                    enabled: true,
                });
                showToast(`Added ${name} to Pausarr`);
                loadContainers();
            }

            async function unmanageContainer(name) {
                await api(`/containers/${name}/unmanage`, "POST");
                showToast(`Removed ${name} from Pausarr`);
                loadContainers();
            }

            async function toggleContainer(name) {
                const result = await api(`/containers/${name}/toggle`, "POST");
                showToast(`${name} ${result.enabled ? "enabled" : "disabled"}`);
            }

            async function pauseContainer(name) {
                const result = await api(`/containers/${name}/pause`, "POST");
                showToast(result.message, result.success ? "success" : "error");
                loadContainers();
            }

            async function unpauseContainer(name) {
                const result = await api(`/containers/${name}/unpause`, "POST");
                showToast(result.message, result.success ? "success" : "error");
                loadContainers();
            }

            // Initial load
            loadStatus();
            loadContainers();
            loadSessions();

            // Auto-refresh - sessions more frequently for real-time feel
            setInterval(loadStatus, 5000);
            setInterval(loadContainers, 10000);
            setInterval(loadSessions, 3000);
        </script>
    </body>
</html>
